Ext.define("Spread.data.DataMatrix",{singleton:true,getFieldNameForColumnIndex:function(a,b){var c=a.getHeaderAtIndex(b);if(c){return c.dataIndex}else{throw"No column found for column index: "+b}},setValueForPosition:function(a,f,d,c){a.update();var g=this.getFieldNameForColumnIndex(a.view,a.column),b;if(!a.record){throw"No record found for row index: "+a.row}if(!a.record["__"+g+"_type"]){a.record["__"+g+"_type"]=this.getTypeForFieldName(g,a.record)}if(a.columnHeader.cellwriter&&Ext.isFunction(a.columnHeader.cellwriter)){f=a.columnHeader.cellwriter(f,a)}else{f=this.castFromString(f,a.record["__"+g+"_type"])}if(a.record.get(g)==f){return f}if(c){var e=a.record[a.record.persistenceProperty][g]=f;a.record.setDirty()}else{var e=a.record.set(g,f)}if(d&&a.columnHeader.autoCommit){a.record.commit()}return e},getTypeForFieldName:function(c,a){var b="auto";a.fields.each(function(d){if(d.name===c&&d.type.type!=="auto"){b=d.type.type}});return b},castFromString:function(a,b){switch(b){case"bool":return(a=="true");case"int":return parseInt(a);case"float":return parseFloat(a);case"auto":case"string":return a.valueOf();case"date":return new Date(a)}},getValueOfPosition:function(a){a.update();var c=this.getFieldNameForColumnIndex(a.view,a.column),b=null;if(!a.record){throw"No record found for row index: "+a.row}b=a.record.get(c);if(a.columnHeader.cellreader&&Ext.isFunction(a.columnHeader.cellreader)){b=a.columnHeader.cellreader(b,a)}return b}});Ext.define("Spread.data.TSVTransformer",{singleton:true,lineSeparator:"\n",columnSeparator:"\t",transformToTSV:function(d){var a=-1,c="";for(var b=0;b<d.length;b++){d[b].update();if(a!==d[b].row&&a!==-1){if(c[c.length-1]==this.columnSeparator){c=c.substring(0,c.length-1)}c=this.addLineBreak(c)}a=d[b].row;c=this.addValue(c,d[b]);if(d[b+1]&&d[b+1].column!==d[+1].view.getSelectionModel().rootPosition.column){c=this.addTabulator(c)}}return c},transformToArray:function(d){var a=[],c=d.split(this.lineSeparator);for(var b=0;b<c.length;b++){a.push(c[b].split(this.columnSeparator))}return a},addLineBreak:function(a){return a+this.lineSeparator},addTabulator:function(a){return a+this.columnSeparator},addValue:function(b,a){return b+=Spread.data.DataMatrix.getValueOfPosition(a)}});Ext.define("Spread.grid.Panel",{extend:"Ext.grid.Panel",alias:"widget.spread",viewType:"spreadview",closeAction:"destroy",autoFocusRootPosition:true,enableKeyNav:true,editable:true,autoCommit:false,editModeStyling:true,columnLines:true,editablePluginConfig:{},copyablePluginConfig:{},pasteablePluginConfig:{},constructor:function(a){var b=this;this.instantiatePlugins();this.addEvents("beforecovercell","covercell","beforehighlightcells","highlightcells","beforeeditfieldblur","editfieldblur","beforecoverdblclick","coverdblclick","beforecoverkeypressed","coverkeypressed","beforeeditingenabled","editingenabled","beforeeditingdisabled","editingdisabled","covercelleditable","editablechange","beforecopy","copy","beforepaste","paste");b.manageViewConfig(a);b.manageSelectionModelConfig(a);b.callParent(arguments);b.relayEvents(b.getView(),["beforecovercell","covercell","beforehighlightcells","highlightcells","beforeeditfieldblur","editfieldblur","beforecoverdblclick","coverdblclick","beforecoverkeypressed","coverkeypressed","beforeeditingenabled","editingenabled","beforeeditingdisabled","editingdisabled","beforecopy","copy","beforepaste","paste","editablechange","covercelleditable"]);if(b.pasteablePluginInstance){b.pasteablePluginInstance.autoCommit=b.autoCommit}b.editablePluginInstance.on("covercelleditable",function(){b.setEditable(b.editable);b.setEditModeStyling(b.editModeStyling)},this,{single:true})},initComponent:function(){this.initColumns();return this.callParent(arguments)},initColumns:function(){for(var a=0;a<this.columns.length;a++){this.columns[a].view=this}},instantiatePlugins:function(){this.editablePluginInstance=Ext.create("Spread.grid.plugin.Editable",this.editablePluginConfig);this.copyablePluginInstance=Ext.create("Spread.grid.plugin.Copyable",this.copyablePluginConfig);this.pasteablePluginInstance=Ext.create("Spread.grid.plugin.Pasteable",this.pasteablePluginConfig)},manageViewConfig:function(a){this.hasView=false;var c=this,b=function(e){e.viewConfig.spreadPlugins=[];e.viewConfig.spreadPlugins.push(c.editablePluginInstance,c.copyablePluginInstance,c.pasteablePluginInstance)};if(a.viewConfig){if(a.viewConfig.spreadPlugins&&Ext.isArray(a.viewConfig.spreadPlugins)){var d=function(e,h){var g=false;for(var f=0;f<a.viewConfig.spreadPlugins.length;f++){if(a.viewConfig.spreadPlugins[f] instanceof e){g=true}}if(!g){a.viewConfig.spreadPlugins.push(h)}};d(Spread.grid.plugin.Editable,this.editablePluginInstance);d(Spread.grid.plugin.Copyable,this.copyablePluginInstance);d(Spread.grid.plugin.Pasteable,this.pasteablePluginInstance)}else{b(a)}if(Ext.isDefined(a.viewConfig.stripeRows)){a.viewConfig.stripeRows=a.viewConfig.stripeRows}else{a.viewConfig.stripeRows=this.stripeRows}}else{a.viewConfig={};b(a)}},manageSelectionModelConfig:function(b){var a={selType:"range"};if(Ext.isDefined(b.autoFocusRootPosition)){a.autoFocusRootPosition=b.autoFocusRootPosition}else{a.autoFocusRootPosition=this.autoFocusRootPosition}if(Ext.isDefined(b.enableKeyNav)){a.enableKeyNav=b.enableKeyNav}else{a.enableKeyNav=this.enableKeyNav}this.selModel=a},setEditable:function(a){this.editable=a;if(this.getView().editable&&this.getView().editable.setDisabled){this.getView().editable.setDisabled(this.editable);this.getView().editable.autoCommit=this.autoCommit}else{throw"You want the grid to be editable, but editing plugin isn't activated!"}},setEditModeStyling:function(a){this.editModeStyling=a;if(this.getView().editable&&this.getView().editable.displayCellsEditing){this.getView().editable.editModeStyling=this.editModeStyling;if(this.editModeStyling&&this.editable){this.getView().editable.displayCellsEditing(true)}else{this.getView().editable.displayCellsEditing(false)}}else{throw"You want the grid to change it's edit mode styling, but editing plugin isn't activated!"}},isEditable:function(){return this.editable}});Ext.define("Spread.grid.View",{extend:"Ext.grid.View",alias:"widget.spreadview",autoFocus:true,autoFocusDelay:50,cellFocusDelay:30,stripeRows:false,trackOver:false,spreadViewBaseCls:"spreadsheet-view",cellCoverEl:null,currentCoverPosition:null,currentHighlightPositions:[],dataChangedRecently:true,cellCoverZIndex:2,selectionCoverZIndex:1,coverPositionTopSubstract:2,coverPositionLeftSubstract:2,coverWidthAddition:3,coverHeightAddition:3,initComponent:function(){this.stripeRows=false;this.baseCls=this.baseCls+" "+this.spreadViewBaseCls;this.addEvents("beforecovercell","covercell","beforehighlightcells","highlightcells","beforeeditfieldblur","editfieldblur","beforecoverdblclick","coverdblclick","beforecoverkeypressed","coverkeypressed","beforeeditingenabled","editingenabled","beforeeditingdisabled","editingdisabled","beforecopy","copy","beforepaste","paste");var a=this.callParent(arguments);if(!this.cellCoverEl){this.createCellCoverElement()}this.initPlugins(this.spreadPlugins);this.initRelayEvents();return a},initRelayEvents:function(){this.relayEvents(this.editable,["beforeeditfieldblur","editfieldblur","beforecoverdblclick","coverdblclick","beforecoverkeypressed","coverkeypressed","beforeeditingenabled","editingenabled","beforeeditingdisabled","editingdisabled","editablechange","covercelleditable"]);this.relayEvents(this.copyable,["beforecopy","copy"]);this.relayEvents(this.pasteable,["beforepaste","paste"])},initPlugins:function(a){for(var b=0;b<a.length;b++){this[a[b].alias]=a[b];this[a[b].alias].init(this)}},createCellCoverElement:function(){var a=this;this.on("afterrender",function(){this.getEl().set({tabIndex:0});if(a.autoFocus){setTimeout(function(){try{a.getEl().focus()}catch(b){}},a.autoFocusDelay)}this.cellCoverEl=Ext.DomHelper.append(this.getEl(),{tag:"div",id:"cover-el"+Ext.id(),cls:"spreadsheet-cell-cover"});Ext.get(this.cellCoverEl).on("mousedown",this.bubbleCellMouseDownToSelectionModel,this);this.headerCt.on("columnresize",function(){this.coverCell()},this)},this)},bubbleCellMouseDownToSelectionModel:function(j,b){var a=b.id.split("_"),d,c,h,g,f;if(a[1]&&Ext.fly(a[1])&&Ext.fly(a[1]).hasCls("x-grid-cell")){a=Ext.fly(a[1]).dom;d=Ext.fly(a).up("tr").dom;f=this.getRecord(d);c=Ext.fly(d).up("tbody").dom;for(var e=0;e<d.childNodes.length;e++){if(d.childNodes[e]===a){g=e;break}}for(var e=0;e<c.childNodes.length;e++){if(c.childNodes[e]===d){h=(e-1);break}}this.getSelectionModel().onCellMouseDown("mousedown",this,a,h,g,j,f,d)}},refresh:function(){var a=this.callParent(arguments);if(this.dataChangedRecently){this.dataChangedRecently=false;return a}else{if(this.editable){this.editable.displayCellsEditing(this.editable.editModeStyling&&this.editable.editable)}}return a},coverCell:function(a){var d=this,c=d.getCellCoverEl();if(d.fireEvent("beforecovercell",d,a,c)!==false){if(a){d.highlightCells()}if(!a){a=d.currentCoverPosition}else{d.currentCoverPosition=a}a.update();var e=Ext.get(a.cellEl),b,f;c.setStyle("display","block");f=e.getXY();f[0]-=d.coverPositionTopSubstract;f[1]-=d.coverPositionLeftSubstract;c.setXY(f);c.setStyle("z-index",d.cellCoverZIndex);b=e.getSize();b.width+=d.coverWidthAddition;b.height+=d.coverHeightAddition;c.setSize(b);c.dom.id="coverOf_"+e.dom.id;setTimeout(function(){d.focusCell(a);try{d.getEl().focus()}catch(g){}},d.cellFocusDelay);d.fireEvent("covercell",d,a,c,e,b,f)}},highlightCells:function(a){var c=this,b=function(d){for(var e=0;e<c.currentHighlightPositions.length;e++){Ext.fly(c.currentHighlightPositions[e].update().cellEl).down("div")[d]("spreadsheet-cell-selection-cover")}};if(this.fireEvent("beforehighlightcells",this,a)!==false){if(this.currentHighlightPositions.length>0){b("removeCls")}if(a){this.currentHighlightPositions=a;b("addCls")}this.fireEvent("highlightcells",this,a)}},getCellCoverEl:function(){return Ext.get(this.cellCoverEl)}});Ext.define("Spread.grid.column.Header",{extend:"Ext.grid.RowNumberer",alias:"widget.spreadheadercolumn",editable:false,columnWidth:60,selectable:false,dataIndex:"id",resizable:true,constructor:function(a){a.width=a.columnWidth||this.columnWidth;this.callParent(arguments)},renderer:function(e,b,a,d,g,c){var f=this.rowspan;if(f){b.tdAttr='rowspan="'+f+'"'}b.tdCls=Ext.baseCSSPrefix+"grid-cell-header "+Ext.baseCSSPrefix+"grid-cell-special";return e}});Ext.define("Spread.overrides.Column",{override:"Ext.grid.column.Column",selectable:true,editable:true,autoCommit:false,cellwriter:null,cellreader:null,editModeStyling:true,allowedEditKeys:[],initialPanelEditModeStyling:false,initComponent:function(){this.initDynamicColumnTdCls();this.callParent(arguments)},initDynamicColumnTdCls:function(){if(!this.selectable){this.editable=false;this.tdCls="spreadsheet-cell-unselectable"}if(this.editable&&this.editModeStyling&&this.initialPanelEditModeStyling){this.tdCls+=" spreadsheet-cell-editable"}}});Ext.define("Spread.util.Clipping",{el:null,refocusDelay:150,initClipping:function(){var a=this;Ext.onReady(function(){if(!a.hasClipboard()){a.createClipboard()}})},prepareForClipboardCopy:function(b,a){var c=this;c.el.dom.style.display="block";c.el.dom.value=b;try{c.el.dom.focus();c.selectClippingText()}catch(d){}c.refocusView(a)},selectClippingText:function(){var b=this,a;if(Ext.isIE){a=b.el.dom.createTextRange();a.collapse(true);a.moveStart("character",0);a.moveEnd("character",b.el.dom.value.length+1);a.select()}else{b.el.dom.select()}},prepareForClipboardPaste:function(d,a){var b=this;b.el.dom.style.display="block";try{b.el.dom.focus();b.selectClippingText()}catch(c){}setTimeout(function(){d(b.el.dom.value);b.el.dom.value=""},150);b.refocusView(a)},createClipboard:function(){this.el=Ext.get(Ext.DomHelper.append(Ext.getBody(),{tag:"textarea",cls:"clipboard-textarea",style:{display:"none",zIndex:-400,position:"absolute",left:"0px",top:"0px",width:"0px",height:"0px"},value:""}))},hasClipboard:function(){var a=Ext.select(".clipboard-textarea").elements[0];if(a){this.el=Ext.get(a);return true}return false},refocusView:function(a){var b=this;setTimeout(function(){try{a.getEl().focus()}catch(c){}b.el.dom.style.display="none"},b.refocusDelay)}});Ext.define("Spread.grid.plugin.Copyable",{extend:"Ext.AbstractComponent",alias:"copyable",mixins:{clipping:"Spread.util.Clipping"},view:null,init:function(a){this.addEvents("beforecopy","copy");this.initClipping();var b=this;b.view=a;this.initKeyNav(a)},initKeyNav:function(a){var b=this;if(!a.rendered){a.on("render",Ext.Function.bind(b.initKeyNav,b,[a],0),b,{single:true});return}a.getEl().on("keydown",b.detectCopyKeyStroke,b)},detectCopyKeyStroke:function(a){if(a.getKey()===a.C&&a.ctrlKey){this.copyToClipboard()}},copyToClipboard:function(){var a=this.view.getSelectionModel(),b=a.getSelectedPositionData();if(this.fireEvent("beforecopy",this,a,b)!==false){this.prepareForClipboardCopy(Spread.data.TSVTransformer.transformToTSV(b),this.view);this.fireEvent("copy",this,a,b)}}});Ext.define("Spread.grid.plugin.Editable",{extend:"Ext.AbstractComponent",alias:"editable",view:null,autoCommit:true,stopEditingFocusDelay:50,retryFieldElFocusDelay:20,chunkRenderDelay:0.1,cellChunkSize:300,activePosition:null,activeCoverEl:null,activeCellTdEl:null,activeCoverElSize:null,activeCoverElPosition:null,cellCoverEditFieldEl:null,isEditing:false,editModeStyling:true,editableCellCls:"spreadsheet-cell-editable",editableDirtyCellCls:"spreadsheet-cell-editable-dirty",lastEditFieldValue:null,editableColumns:[],editableColumnIndexes:[],editable:false,init:function(a){var b=this;b.view=a;this.addEvents("beforeeditfieldblur","editfieldblur","beforecoverdblclick","coverdblclick","beforecoverkeypressed","coverkeypressed","beforeeditingenabled","editingenabled","beforeeditingdisabled","editingdisabled","covercelleditable","editablechange");this.initCoverEventing()},initCoverEventing:function(){var a=this;this.view.on("afterrender",function(b){a.initEditingColumns(b);a.initEventing(b)})},initEventing:function(a){var c=this,b=a.getCellCoverEl();if(b){c.initTextField(b);c.view.getEl().on("dblclick",c.onCoverDblClick,c);a.getEl().on("keydown",c.onCoverKeyPressed,c);a.on("covercell",c.onCellCovered,c);a.getSelectionModel().on("beforecellfocus",c.blurEditFieldIfEditing,c);a.getSelectionModel().on("keynavigate",c.blurEditFieldIfEditing,c)}else{throw"Cover element not found, initializing editing failed! Please check proper view rendering."}},initEditingColumns:function(a){var c=a.getHeaderCt().getGridColumns();this.editableColumns=[];this.editableColumnIndexes=[];for(var b=0;b<c.length;b++){if(c[b].editable){this.editableColumns.push(c[b]);c[b].columnIndex=b;this.editableColumnIndexes.push(b)}}},initTextField:function(a){if(!this.cellCoverEditFieldEl){this.cellCoverEditFieldEl=Ext.get(Ext.DomHelper.append(a,{id:Ext.id()+"-cover-input",tag:"input",type:"text",cls:"spreadsheet-cell-cover-edit-field",value:""}));this.cellCoverEditFieldEl.on("keypress",this.onEditFieldKeyPressed,this)}},onEditFieldBlur:function(){if(this.fireEvent("beforeeditfieldblur",this)!==false){this.view.dataChangedRecently=true;this.setEditing(false);Spread.data.DataMatrix.setValueForPosition(this.activePosition,this.getEditingValue(),this.autoCommit);this.handleDirtyMarkOnEditModeStyling();this.fireEvent("editfieldblur",this)}},handleDirtyMarkOnEditModeStyling:function(){if(this.view.ownerCt.editModeStyling){this.displayCellsEditing(true)}else{this.displayCellsEditing(false)}},blurEditFieldIfEditing:function(){if(this.isEditing){this.onEditFieldBlur()}},onEditFieldKeyPressed:function(a){var b=this;if(this.isEditing){if(Spread.util.Key.isCancelEditKey(a)){this.blurEditFieldIfEditing();return true}if(b.activePosition.columnHeader.allowedEditKeys.length>0){if(Ext.Array.indexOf(b.activePosition.columnHeader.allowedEditKeys,String.fromCharCode(a.getCharCode()))===-1&&a.getKey()!==a.BACKSPACE){a.stopEvent()}}}else{if(a.getKey()===a.ENTER){b.view.getSelectionModel().onKeyEnter(a)}if(a.getKey()===a.TAB){b.view.getSelectionModel().onKeyTab(a)}if(a.getKey()===a.LEFT){b.view.getSelectionModel().onKeyLeft(a)}if(a.getKey()===a.RIGHT){b.view.getSelectionModel().onKeyRight(a)}if(a.getKey()===a.UP){b.view.getSelectionModel().onKeyUp(a)}if(a.getKey()===a.DOWN){b.view.getSelectionModel().onKeyDown(a)}}},isOriginCellClick:function(a){var d=false,c=a.getTarget().parentNode.parentNode.id,e=a.getTarget().parentNode.id,f=a.getTarget().id,b=this.view.getSelectionModel().getCurrentFocusPosition().cellEl.id;if(Ext.isIE){if(f.indexOf(b)>-1||e.indexOf(b)>-1||c.indexOf(b)>-1){d=true}}else{if(f.indexOf(b)>-1){d=true}}return d},onCoverDblClick:function(a){if(this.fireEvent("beforecoverdblclick",this)!==false){if(!Ext.get(a.getTarget()).hasCls("x-grid-view")&&!this.isEditing&&this.isOriginCellClick(a)&&this.isPositionEditable()){this.setEditing(true);this.setEditingValue(Spread.data.DataMatrix.getValueOfPosition(this.activePosition))}this.fireEvent("coverdblclick",this)}},onCoverKeyPressed:function(a,b){if(this.isEditing){return}if(this.fireEvent("beforecoverkeypressed",this)!==false){if(Spread.util.Key.isStartEditKey(a)&&!this.isEditing){if(this.isPositionEditable()){this.setEditing(true);this.setEditingValue("")}}this.fireEvent("coverkeypressed",this)}},onCellCovered:function(b,a,d,e,c,f){this.activePosition=a;this.activeCellTdEl=e;this.activeCoverEl=d;this.activeCoverElSize=c;this.activeCoverElPosition=f;this.cellCoverEditFieldEl.dom.style.display="none";this.fireEvent("covercelleditable",this,b,a,d)},isPositionEditable:function(){if((this.activePosition&&!this.activePosition.columnHeader.editable)||!this.editable){return false}return true},setEditing:function(c){var a=this;if(!Ext.isDefined(c)){c=true}if(!this.isPositionEditable()){return false}if(c){if(this.fireEvent("beforeeditingenabled",this)!==false){a.isEditing=true;a.cellCoverEditFieldEl.dom.style.display="inline";try{a.cellCoverEditFieldEl.dom.focus()}catch(b){}setTimeout(function(){try{a.cellCoverEditFieldEl.dom.focus()}catch(d){}},a.retryFieldElFocusDelay);this.fireEvent("editingenabled",this)}}else{if(this.fireEvent("beforeeditingdisabled",this)!==false){a.cellCoverEditFieldEl.dom.style.display="none";setTimeout(function(){try{a.view.focus()}catch(d){}},a.stopEditingFocusDelay);a.isEditing=false;this.fireEvent("editingdisabled",this)}}},setEditingValue:function(a){this.cellCoverEditFieldEl.dom.value=a},getEditingValue:function(){return this.cellCoverEditFieldEl.dom.value},setDisabled:function(c){var a=this,b=function(d){for(var e=0;e<a.editableColumns.length;e++){a.editableColumns[e].editable=d}};if(!c){a.setEditing(false);a.editable=false;b(false);if(a.editModeStyling){a.displayCellsEditing(false,function(){a.fireEvent("editablechange",a,c)})}else{a.fireEvent("editablechange",a,c)}}else{a.editable=true;b(true);if(a.editModeStyling){a.displayCellsEditing(true,function(){a.fireEvent("editablechange",a,c)})}else{a.fireEvent("editablechange",a,c)}}},displayCellsEditing:function(c,f){var d=this,b=d.view.getEl().query(d.view.cellSelector),a=d.view.getHeaderCt().getGridColumns();if(Ext.isIE6||Ext.isIE7||Ext.isIE8){d.chunkRenderDelay=0.3;d.cellChunkSize=200}var e=function(h,j){for(var g=h;g<j;g++){if(!b[g]||Ext.Array.indexOf(d.editableColumnIndexes,b[g].cellIndex)<0||(a[b[g].cellIndex]&&a[b[g].cellIndex].editModeStyling===false)){continue}if(c){if(!Ext.fly(b[g]).hasCls(d.editableCellCls)){if(Ext.fly(b[g]).hasCls("x-grid-dirty-cell")){Ext.fly(b[g]).addCls(d.editableDirtyCellCls)}else{Ext.fly(b[g]).addCls(d.editableCellCls)}}}else{Ext.fly(b[g]).removeCls(d.editableCellCls);Ext.fly(b[g]).removeCls(d.editableDirtyCellCls)}}if(j<b.length){h+=d.cellChunkSize;j+=d.cellChunkSize;setTimeout(function(){e(h,j)},d.chunkRenderDelay)}else{if(f&&Ext.isFunction(f)){f()}}};e(0,d.cellChunkSize)}});Ext.define("Spread.grid.plugin.Pasteable",{alias:"pasteable",extend:"Ext.AbstractComponent",mixins:{clipping:"Spread.util.Clipping"},view:null,autoCommit:false,loadMask:true,useInternalAPIs:false,init:function(a){this.addEvents("beforepaste","paste");this.initClipping();var b=this;b.view=a;this.initKeyNav(a)},initKeyNav:function(a){var b=this;if(!a.rendered){a.on("render",Ext.Function.bind(b.initKeyNav,b,[a],0),b,{single:true});return}a.getEl().on("keydown",b.detectPasteKeyStroke,b)},detectPasteKeyStroke:function(a){if(a.getKey()===a.V&&a.ctrlKey){this.pasteFromClipboard()}},pasteFromClipboard:function(){var c=this,a=this.view.getSelectionModel(),d=a.getSelectedPositionData();if(c.loadMask){var b=new Ext.LoadMask(c.view.getEl());b.show()}if(this.fireEvent("beforepaste",this,a,d)!==false){this.prepareForClipboardPaste(function(f){var e=Spread.data.TSVTransformer.transformToArray(f);c.updateRecordFieldsInStore(e,d,a);c.fireEvent("paste",c,a,d,e);if(c.loadMask){b.hide()}},this.view)}},updateRecordFieldsInStore:function(d,c,h){var m=this;function j(o,i){h.currentFocusPosition=i;h.originSelectionPosition=o;h.tryToSelectRange(true)}if(c.length===0||d.length===0){return}if(d.length===1&&d[0].length===1){var l=c[0].update();if(!l.columnHeader.editable){return}Spread.data.DataMatrix.setValueForPosition(l,d[0][0],m.autoCommit);m.handleDirtyMarkOnEditModeStyling();return}if(c.length===1){var n=c[0].update(),e=n.column,b=n.row,l=null;b+=(d.length-1);e+=(d[0].length-1);l=new Spread.selection.Position(m.view,e,b);j(n,l)}c=h.getSelectedPositionData();var n=c[0].update();var g=0;var k=0;var a=0;for(var f=0;f<c.length;f++){c[f].update();if(!c[f].columnHeader.editable){continue}k=(c[f].row-n.row);g=(c[f].column-n.column);a=k;Spread.data.DataMatrix.setValueForPosition(c[f],d[k][g],m.autoCommit,m.useInternalAPIs)}m.view.refresh();m.handleDirtyMarkOnEditModeStyling();m.view.highlightCells(c)},handleDirtyMarkOnEditModeStyling:function(){if(this.view.editable){this.view.editable.displayCellsEditing(false);if(this.view.ownerCt.editModeStyling){this.view.editable.displayCellsEditing(true)}}}});Ext.define("Spread.selection.Position",{view:null,column:-1,row:-1,record:null,model:null,columnHeader:null,rowEl:null,cellEl:null,constructor:function(i,f,g,e,b,a){var d=i.getStore().getCount(),h=i.headerCt.getGridColumns(true).length;if(f>=h){f=(h-1)}if(g>=d){g=(d-1)}var b=b||i.getNode(g),e=e||i.getStore().getAt(g),c=null;if(b){a=a||b.childNodes[f]}else{a=a||null}if(e){c=e.self}Ext.apply(this,{view:i,column:f,row:g,record:c,model:e?e.self:undefined,columnHeader:i.getHeaderAtIndex(f),rowEl:b,cellEl:a})},update:function(){this.record=this.view.getStore().getAt(this.row);if(this.record){this.model=this.record.self}else{this.model=null}this.columnHeader=this.view.getHeaderAtIndex(this.column);this.rowEl=this.view.getNode(this.row);if(this.rowEl){this.cellEl=this.rowEl.childNodes[this.column]}return this}});Ext.define("Spread.selection.RangeModel",{extend:"Ext.selection.Model",alias:"selection.range",isRangeModel:true,initialViewRefresh:true,dataChangedRecently:false,keyNav:null,keyNavigation:false,mayRangeSelecting:false,rootPosition:null,autoFocusRootPosition:true,enableKeyNav:true,currentSelectionRange:[],originSelectionPosition:null,currentFocusPosition:null,view:null,grid:null,constructor:function(){this.addEvents("deselect","select","beforecellfocus","cellfocus","cellblur","tabselect","enterselect","keynavigate");this.callParent(arguments)},bindComponent:function(a){var b=this;b.view=a;b.grid=b.view.ownerCt;b.callParent(arguments);b.initRootPosition();b.bindUIEvents();if(b.enableKeyNav){b.initKeyNav(a)}},initRootPosition:function(){var b=0,c=false,a=false;while(!c){if(!this.view.getHeaderAtIndex(b)){c=true;a=true}if(this.view.getHeaderAtIndex(b)&&this.view.getHeaderAtIndex(b).selectable){c=true}else{b++}}this.rootPosition=new Spread.selection.Position(this.view,b,0,this.view.getStore().getAt(0))},bindUIEvents:function(){var a=this;a.view.on({uievent:a.onUIEvent,refresh:a.onViewRefresh,scope:a});a.view.ownerCt.on({columnhide:a.reinitialize,columnmove:a.reinitialize,columnshow:a.reinitialize,scope:a});a.view.store.on("datachanged",function(){a.dataChangedRecently=true});a.initEditBlurHandler()},initEditBlurHandler:function(){var a=this;a.grid.on("destroy",function(){Ext.EventManager.un(document.body,"mouseup",a.onCellMouseUp)});Ext.EventManager.on(document.body,"mouseup",a.onCellMouseUp,a)},reinitialize:function(){this.initRootPosition();try{this.setCurrentFocusPosition(this.rootPosition)}catch(a){}this.setOriginSelectionPosition(this.rootPosition)},initKeyNav:function(a){var b=this;if(!a.rendered){a.on("render",Ext.Function.bind(b.initKeyNav,b,[a],0),b,{single:true});return}a.el.set({tabIndex:-1});b.keyNav=new Ext.util.KeyNav({target:a.el,eventName:"keydown",ignoreInputFields:true,right:b.onKeyRight,left:b.onKeyLeft,scope:b});b.keyNav=new Ext.util.KeyNav({target:a.el,eventName:"keydown",ignoreInputFields:false,up:b.onKeyUp,down:b.onKeyDown,tab:b.onKeyTab,enter:b.onKeyEnter,scope:b})},onViewRefresh:function(){if(this.dataChangedRecently){this.reinitialize();this.dataChangedRecently=false}else{this.rootPosition.update();try{this.view.getEl().focus()}catch(a){}}if(this.autoFocusRootPosition&&this.initialViewRefresh){try{this.setCurrentFocusPosition(this.rootPosition)}catch(a){}this.setOriginSelectionPosition(this.rootPosition);this.initialViewRefresh=false}},onUIEvent:function(d,g,i,f,e,h,a,j){var c=this,b=arguments;switch(d){case"mouseover":c.onCellMouseOver.apply(c,b);break;case"mousedown":c.onCellMouseDown.apply(c,b);break}},onCellMouseDown:function(d,g,i,f,e,h,b,j,c){if(!c){return}var a=new Spread.selection.Position(g,e,f,b,j,i);if(this.setCurrentFocusPosition(a)){if(h.shiftKey&&!Spread.util.Key.isStartEditKey(h)){this.tryToSelectRange()}else{this.setOriginSelectionPosition(a);this.mayRangeSelecting=true}}},getNextRowIndex:function(a,b){if((b+1)<a.getCount()){++b}return b},onCellMouseOver:function(f,d,a,h,e,c,b,g){if(this.mayRangeSelecting){if(this.setCurrentFocusPosition(new Spread.selection.Position(d,e,h,b,g,a))){this.tryToSelectRange()}}},onCellMouseUp:function(a,b){this.mayRangeSelecting=false;if(!Ext.get(b).hasCls("spreadsheet-cell-cover")&&!Ext.get(b).hasCls("x-grid-cell-inner")&&!Ext.get(b).hasCls("spreadsheet-cell-cover-edit-field")){this.fireEvent("cellblur",this,Ext.get(b))}},onKeyUp:function(a){if(!this.getCurrentFocusPosition()){return}this.keyNavigation=true;this.processKeyNavigation("up",a);this.keyNavigation=false},onKeyDown:function(a){if(!this.getCurrentFocusPosition()){return}this.keyNavigation=true;this.processKeyNavigation("down",a);this.keyNavigation=false},onKeyLeft:function(a){if(Ext.get(a.getTarget()).hasCls("spreadsheet-cell-cover-edit-field")){return}if(!this.getCurrentFocusPosition()){return}this.keyNavigation=true;this.processKeyNavigation("left",a);this.keyNavigation=false},onKeyRight:function(a){if(Ext.get(a.getTarget()).hasCls("spreadsheet-cell-cover-edit-field")){return}if(!this.getCurrentFocusPosition()){return}this.keyNavigation=true;this.processKeyNavigation("right",a);this.keyNavigation=false},onKeyTab:function(a){if(!this.getCurrentFocusPosition()||!a){return}this.fireEvent("tabselect",this,a);this.keyNavigation=true;if(!a.shiftKey){this.processKeyNavigation("right",a)}else{this.processKeyNavigation("left",a)}this.keyNavigation=false},onKeyEnter:function(a){if(!this.getCurrentFocusPosition()){return}this.fireEvent("enterselect",this,a);this.keyNavigation=true;this.processKeyNavigation("down",a);this.keyNavigation=false},setCurrentFocusPosition:function(a){if(!a){this.currentFocusPosition=null;return false}if(!a.columnHeader.selectable){return false}if(this.fireEvent("beforecellfocus",a)!==false){this.currentFocusPosition=a;this.currentSelectionRange=[];this.view.coverCell(a);this.fireEvent("cellfocus",a);return true}return false},getCurrentFocusPosition:function(){return this.currentFocusPosition},setOriginSelectionPosition:function(a){this.originSelectionPosition=a},getOriginSelectionPosition:function(){return this.originSelectionPosition},processKeyNavigation:function(b,a){setTimeout(Ext.Function.bind(function(){this.fireEvent("keynavigate",this,b,a);var c=this.tryMoveToPosition(this.getCurrentFocusPosition(),b,a);if(this.setCurrentFocusPosition(c)){if(a.shiftKey&&a.getKey()!==a.TAB){this.tryToSelectRange()}else{this.setOriginSelectionPosition(c)}}},this),50)},tryMoveToPosition:function(c,d,a){var b=this.view.walkCells(c,d,a,true);if(!b&&!a.shiftKey&&d==="right"){b=new Spread.selection.Position(c.view,this.rootPosition.column,this.getNextRowIndex(c.view.getStore(),c.row))}else{if(!b){b=c}}return new Spread.selection.Position(this.view,b.column,b.row)},tryToSelectRange:function(a){var j=function(q,p){var o=[];do{o.push(q);q++}while(q<=p);return o};var l=this.view.getStore().getCount(),i=this.view.headerCt.getGridColumns(true).length,c=this.getOriginSelectionPosition().row,d=this.getCurrentFocusPosition().row,e=this.getOriginSelectionPosition().column,g=this.getCurrentFocusPosition().column,m=[],h=[],b=[],f=null;if(d<=c){m=j(d,c)}else{m=j(c,d)}if(g<=e){h=j(g,e)}else{h=j(e,g)}for(var k=0;k<l;k++){for(var n=0;n<i;n++){if(Ext.Array.indexOf(m,k)>-1&&Ext.Array.indexOf(h,n)>-1){f=new Spread.selection.Position(this.view,n,k).update();if(!f.columnHeader.hidden){b.push(f)}}}}this.currentSelectionRange=b;if(!a){this.view.highlightCells(b)}},getSelectedPositionData:function(){var a;if(this.currentSelectionRange.length===0){a=[this.currentFocusPosition]}else{a=this.currentSelectionRange}return a}});Ext.define("Spread.util.Key",{singleton:true,specialKeyPressedBefore:null,isCancelEditKey:function(a){var b=a.normalizeKey(a.keyCode);return((b>=33&&b<=40)&&b!=37&&b!=39)||b==a.RETURN||b==a.TAB||b==a.ESC||b==91||(!Ext.isIE&&b===224)},isStartEditKey:function(a){var c=this,b=a.normalizeKey(a.keyCode);if(c.specialKeyPressedBefore){c.specialKeyPressedBefore=false;return false}if(a.ctrlKey){return false}if(Ext.isIE&&b===91){c.specialKeyPressedBefore=true}return(b>=48&&b<=57)||(b>=65&&b<=90)||(b>=96&&b<=111)||(b>=173&&b<=222)}});